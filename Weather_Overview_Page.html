<!DOCTYPE html>
<html>
<head>
    <title>West Coast Overview</title>

    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="refresh" content="600"> <!-- Refresh every 1 minutes -->
   
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>
    <style type="text/css">
        li {
            list-style: none;
            display: inline-block;
        }
    </style>
    <style>
   
        .dropbtn {
           
        }

        .dropbtn:hover, .dropbtn:focus {
            background-color: yellow;
        }

        .dropdown {
            text-align: right;
            position: relative; top: 0px; left: 0px; right: 0px; height: 50px; z-index: 100;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #f1f1f1;
            min-width: 160px;
            overflow: auto;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 100;
        }

        .dropdown-content a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
        }

        .dropdown:hover .dropdown-content {display: block;}
        .dropdown a:hover {background-color: #ddd;}

        .show {display: block;}
   
    </style>
</head>

<body style="background-color: #000000">
<h1 style="color: #ffffff;">West Coast</h1>
<ul style="text-align: center; position: absolute;top: 0; left: 0; right: 0; height: 50px;">
    <li><input type="button" onclick="stop(); showFrame(animationPosition - 1); return;" value="&lt;" /></li>
    <li><input type="button" onclick="playStop();" value="Play / Stop" /></li>
    <button onClick="window.location.reload();">Reset Page</button>
    <li><input type="button" onclick="stop(); showFrame(animationPosition + 1); return;" value="&gt;" /></li>
    <div class="dropdown">
        <button onclick="myFunction()" class="dropbtn">Weather Locations v</button>
        <div id="myDropdown" class="dropdown-content">
            <a href="Weather_Overview_Page.html">West Coast Overview</a>
            <a href="SoCal.html">SoCal</a>
            <a href="CenCal.html">CenCal</a>
            <a href="https://www.swpc.noaa.gov/communities/space-weather-enthusiasts-dashboard" target="_blank">Space Weather</a>
        </div>
    </div>
   
</ul>
   
<div id="timestamp" style="text-align:center; position: absolute;top: 50px; left: 0; right: 0; height: 80px; color: #ffffff">FRAME TIME</div>

<div id="mapid" style="position: absolute; top: 80px; left: 0; bottom: 0; right: 0; z-index: 0;"></div>


<script>
   
   var HomeIcon = L.icon({
    iconUrl: 'Home_Icon.png',
    iconSize:     [20, 30], // size of the icon
    iconAnchor:   [6.5, 30], // point of the icon which will correspond to marker's location
    popupAnchor:  [-3, -76], // point from which the popup should open relative to the iconAnchor
});
   
   
    var map = L.map('mapid').setView([40, -119.830387], 4.5);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attributions: 'Map data Â© <a href="https://openstreetmap.org">OpenStreetMap</a> contributors'
    }).addTo(map);

    L.marker([32.802107,-117.038372],{icon: HomeIcon}).bindTooltip("Home", {permanent: true, className: "my-label" }).addTo(map);
    L.marker([36.366409,-119.658222],{icon: HomeIcon}).bindTooltip("Hanford Home", {permanent: true, className: "my-label" }).addTo(map);
   
    /**
     * RainViewer radar animation part
     * @type {number[]}
     */
    var timestamps = [];
    var radarLayers = [];

    var animationPosition = 0;
    var animationTimer = false;

    /**
     * Load actual radar animation frames timestamps from RainViewer API
     */
    var apiRequest = new XMLHttpRequest();
    apiRequest.open("GET", "https://api.rainviewer.com/public/maps.json", true);
    apiRequest.onload = function(e) {

        // save available timestamps and show the latest frame: "-1" means "timestamp.lenght - 1"
        timestamps = JSON.parse(apiRequest.response);
        showFrame(-1);
    };
    apiRequest.send();

    /**
     * Animation functions
     * @param ts
     */
    function addLayer(ts) {
        if (!radarLayers[ts]) {
            radarLayers[ts] = new L.TileLayer('https://tilecache.rainviewer.com/v2/radar/' + ts + '/256/{z}/{x}/{y}/4/1_1.png', {
                tileSize: 256,
                opacity: 0.001,
                zIndex: ts
            });
        }
        if (!map.hasLayer(radarLayers[ts])) {
            map.addLayer(radarLayers[ts]);
        }
    }

    /**
     * Display particular frame of animation for the @position
     * If preloadOnly parameter is set to true, the frame layer only adds for the tiles preloading purpose
     * @param position
     * @param preloadOnly
     */
    function changeRadarPosition(position, preloadOnly) {
        while (position >= timestamps.length) {
            position -= timestamps.length;
        }
        while (position < 0) {
            position += timestamps.length;
        }

        var currentTimestamp = timestamps[animationPosition];
        var nextTimestamp = timestamps[position];

        addLayer(nextTimestamp);

        if (preloadOnly) {
            return;
        }

        animationPosition = position;

        if (radarLayers[currentTimestamp]) {
            radarLayers[currentTimestamp].setOpacity(0);
        }
        radarLayers[nextTimestamp].setOpacity(100);

        document.getElementById("timestamp").innerHTML = (new Date(nextTimestamp * 1000)).toString();
    }

    /**
     * Check avialability and show particular frame position from the timestamps list
     */
    function showFrame(nextPosition) {
        var preloadingDirection = nextPosition - animationPosition > 0 ? 1 : -1;

        changeRadarPosition(nextPosition);

        // preload next next frame (typically, +1 frame)
        // if don't do that, the animation will be blinking at the first loop
        changeRadarPosition(nextPosition + preloadingDirection, true);
    }

    /**
     * Stop the animation
     * Check if the animation timeout is set and clear it.
     */
    function stop() {
        if (animationTimer) {
            clearTimeout(animationTimer);
            animationTimer = false;
            return true;
        }
        return false;
    }

    function play() {
        showFrame(animationPosition + 1);

        // Main animation driver. Run this function every 500 ms
        animationTimer = setTimeout(play, 500);
    }

    function playStop() {
        if (!stop()) {
            play();
        }
    }
   
    function myFunction() {
        document.getElementById("myDropdown").classList.toggle("show");
    }
   
// Close the dropdown if the user clicks outside of it
    window.onclick = function(event) {
        if (!event.target.matches('.dropbtn')) {
            var dropdowns = document.getElementsByClassName("dropdown-content");
            var i;
        for (i = 0; i < dropdowns.length; i++) {
            var openDropdown = dropdowns[i];
        if (openDropdown.classList.contains('show')) {
            openDropdown.classList.remove('show');
        }
        }
        }
    }
</script>

</body>
</html>